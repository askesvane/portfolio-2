Welcome to the third exciting part of the Language Development in ASD exercise
------------------------------------------------------------------------------

In this part of the assignment, we try to figure out how a new study
should be planned (i.e. how many participants?) in order to have enough
power to replicate the findings (ensuring our sample size is adequate,
our alpha at 0.05 and our beta at 0.8): 1- if we trust the estimates of
the current study. Report the power analysis and comment on what you can
(or cannot) use its estimates for. 2- if we are skeptical of the current
study. Report the power analysis and comment on what you can (or cannot)
use its estimates for. 3- if we only have access to 30 participants.
Identify the power for each relevant effect and discuss whether it's
worth to run the study and why The list above is also what you should
discuss in your code-less report.

Learning objectives
-------------------

-   Learn how to calculate statistical power
-   Critically appraise how to apply frequentist statistical power

### Exercise 1

How much power does your study have (if your model estimates are quite
right)? - Load your dataset (both training and testing), fit your
favorite model, assess power for your effects of interest (probably your
interactions). - Report the power analysis and comment on what you can
(or cannot) use its estimates for.

-   Test how many participants you would have to have to replicate the
    findings (assuming the findings are correct)

N.B. Remember that main effects are tricky once you have interactions in
the model (same for 2-way interactions w 3-way interactions in the
model). If you want to test the power of main effects, run a model
excluding the interactions. N.B. Check this paper:
<https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12504>
You will be using: - powerSim() to calculate power - powerCurve() to
estimate the needed number of participants - extend() to simulate more
participants

    # Import processed data from A2P2
    train <- read.csv("train_correct.csv")
    test <- read.csv("test_correct.csv")

    # Combining the two dataframes
    df <- rbind(train,test)
    df$Child.ID <- as.factor(df$Child.ID)



    #load packages
    library(pacman)
    p_load(tidyverse, lme4, nlme, simr, lmerTest)

    ## Calculate power ##

    # models
    #  used to test if the power function works
    simple <- lmer(CHI_MLU ~ Visit + Diagnosis + verbalIQ1 + (1 + Visit | Child.ID), 
                  data=df, REML = F, control = lmerControl(optimizer = "nloptwrap", calc.derivs = F))
    # actual model
    model <-  lmer(CHI_MLU ~ Visit * Diagnosis * verbalIQ1 + (1+Visit|Child.ID),
                  data=df, REML = F, control = lmerControl(optimizer = "nloptwrap", calc.derivs = F))

    # effect estimates of models
    print(fixed.effects(simple))

    ## (Intercept)       Visit DiagnosisTD   verbalIQ1 
    ##  -0.3048708   0.2327246   0.1652795   0.0755599

    print(fixed.effects(model))

    ##                 (Intercept)                       Visit 
    ##                  0.20162909                 -0.08175900 
    ##                 DiagnosisTD                   verbalIQ1 
    ##                 -0.65606168                  0.06369347 
    ##           Visit:DiagnosisTD             Visit:verbalIQ1 
    ##                  0.65125483                  0.01035339 
    ##       DiagnosisTD:verbalIQ1 Visit:DiagnosisTD:verbalIQ1 
    ##                  0.01417522                 -0.02128945

    # test models - power analysis 
    power_visit <- powerSim(simple, test = fixed("Visit"), nsim = 100) #100 percent

    ## Simulating: |                                                             |Simulating: |=                                                            |Simulating: |==                                                           |Simulating: |===                                                          |Simulating: |====                                                         |Simulating: |=====                                                        |Simulating: |======                                                       |Simulating: |=======                                                      |Simulating: |========                                                     |Simulating: |=========                                                    |Simulating: |==========                                                   |Simulating: |===========                                                  |Simulating: |============                                                 |Simulating: |=============                                                |Simulating: |==============                                               |Simulating: |===============                                              |Simulating: |================                                             |Simulating: |=================                                            |Simulating: |==================                                           |Simulating: |===================                                          |Simulating: |====================                                         |Simulating: |=====================                                        |Simulating: |======================                                       |Simulating: |=======================                                      |Simulating: |========================                                     |Simulating: |=========================                                    |Simulating: |==========================                                   |Simulating: |===========================                                  |Simulating: |============================                                 |Simulating: |=============================                                |Simulating: |==============================                               |Simulating: |===============================                              |Simulating: |================================                             |Simulating: |=================================                            |Simulating: |==================================                           |Simulating: |===================================                          |Simulating: |====================================                         |Simulating: |=====================================                        |Simulating: |======================================                       |Simulating: |=======================================                      |Simulating: |========================================                     |Simulating: |=========================================                    |Simulating: |==========================================                   |Simulating: |===========================================                  |Simulating: |============================================                 |Simulating: |=============================================                |Simulating: |==============================================               |Simulating: |===============================================              |Simulating: |================================================             |Simulating: |=================================================            |Simulating: |==================================================           |Simulating: |===================================================          |Simulating: |====================================================         |Simulating: |=====================================================        |Simulating: |======================================================       |Simulating: |=======================================================      |Simulating: |========================================================     |Simulating: |=========================================================    |Simulating: |==========================================================   |Simulating: |===========================================================  |Simulating: |============================================================ |Simulating: |=============================================================|

    ## Warning in observedPowerWarning(sim): This appears to be an "observed
    ## power" calculation

    power_diagnosis <- powerSim(simple, test = fixed("Diagnosis"), nsim = 100) #56 pecent 

    ## Simulating: |                                                             |Simulating: |=                                                            |Simulating: |==                                                           |Simulating: |===                                                          |Simulating: |====                                                         |Simulating: |=====                                                        |Simulating: |======                                                       |Simulating: |=======                                                      |Simulating: |========                                                     |Simulating: |=========                                                    |Simulating: |==========                                                   |Simulating: |===========                                                  |Simulating: |============                                                 |Simulating: |=============                                                |Simulating: |==============                                               |Simulating: |===============                                              |Simulating: |================                                             |Simulating: |=================                                            |Simulating: |==================                                           |Simulating: |===================                                          |Simulating: |====================                                         |Simulating: |=====================                                        |Simulating: |======================                                       |Simulating: |=======================                                      |Simulating: |========================                                     |Simulating: |=========================                                    |Simulating: |==========================                                   |Simulating: |===========================                                  |Simulating: |============================                                 |Simulating: |=============================                                |Simulating: |==============================                               |Simulating: |===============================                              |Simulating: |================================                             |Simulating: |=================================                            |Simulating: |==================================                           |Simulating: |===================================                          |Simulating: |====================================                         |Simulating: |=====================================                        |Simulating: |======================================                       |Simulating: |=======================================                      |Simulating: |========================================                     |Simulating: |=========================================                    |Simulating: |==========================================                   |Simulating: |===========================================                  |Simulating: |============================================                 |Simulating: |=============================================                |Simulating: |==============================================               |Simulating: |===============================================              |Simulating: |================================================             |Simulating: |=================================================            |Simulating: |==================================================           |Simulating: |===================================================          |Simulating: |====================================================         |Simulating: |=====================================================        |Simulating: |======================================================       |Simulating: |=======================================================      |Simulating: |========================================================     |Simulating: |=========================================================    |Simulating: |==========================================================   |Simulating: |===========================================================  |Simulating: |============================================================ |Simulating: |=============================================================|

    ## Warning in observedPowerWarning(sim): This appears to be an "observed
    ## power" calculation

    power_verbal <- powerSim(simple, test = fixed("verbalIQ1"), nsim = 100) #100 percent

    ## Simulating: |                                                             |Simulating: |=                                                            |Simulating: |==                                                           |Simulating: |===                                                          |Simulating: |====                                                         |Simulating: |=====                                                        |Simulating: |======                                                       |Simulating: |=======                                                      |Simulating: |========                                                     |Simulating: |=========                                                    |Simulating: |==========                                                   |Simulating: |===========                                                  |Simulating: |============                                                 |Simulating: |=============                                                |Simulating: |==============                                               |Simulating: |===============                                              |Simulating: |================                                             |Simulating: |=================                                            |Simulating: |==================                                           |Simulating: |===================                                          |Simulating: |====================                                         |Simulating: |=====================                                        |Simulating: |======================                                       |Simulating: |=======================                                      |Simulating: |========================                                     |Simulating: |=========================                                    |Simulating: |==========================                                   |Simulating: |===========================                                  |Simulating: |============================                                 |Simulating: |=============================                                |Simulating: |==============================                               |Simulating: |===============================                              |Simulating: |================================                             |Simulating: |=================================                            |Simulating: |==================================                           |Simulating: |===================================                          |Simulating: |====================================                         |Simulating: |=====================================                        |Simulating: |======================================                       |Simulating: |=======================================                      |Simulating: |========================================                     |Simulating: |=========================================                    |Simulating: |==========================================                   |Simulating: |===========================================                  |Simulating: |============================================                 |Simulating: |=============================================                |Simulating: |==============================================               |Simulating: |===============================================              |Simulating: |================================================             |Simulating: |=================================================            |Simulating: |==================================================           |Simulating: |===================================================          |Simulating: |====================================================         |Simulating: |=====================================================        |Simulating: |======================================================       |Simulating: |=======================================================      |Simulating: |========================================================     |Simulating: |=========================================================    |Simulating: |==========================================================   |Simulating: |===========================================================  |Simulating: |============================================================ |Simulating: |=============================================================|

    ## Warning in observedPowerWarning(sim): This appears to be an "observed
    ## power" calculation

    #not relevant to test individually because the model has interactions, therefore:
    interaction <- powerSim(model, test = fixed("Visit:Diagnosis:verbalIQ1"), nsim = 100) # ca. 98 percent

    ## Simulating: |                                                             |Simulating: |=                                                            |Simulating: |==                                                           |Simulating: |===                                                          |Simulating: |====                                                         |Simulating: |=====                                                        |Simulating: |======                                                       |Simulating: |=======                                                      |Simulating: |========                                                     |Simulating: |=========                                                    |Simulating: |==========                                                   |Simulating: |===========                                                  |Simulating: |============                                                 |Simulating: |=============                                                |Simulating: |==============                                               |Simulating: |===============                                              |Simulating: |================                                             |Simulating: |=================                                            |Simulating: |==================                                           |Simulating: |===================                                          |Simulating: |====================                                         |Simulating: |=====================                                        |Simulating: |======================                                       |Simulating: |=======================                                      |Simulating: |========================                                     |Simulating: |=========================                                    |Simulating: |==========================                                   |Simulating: |===========================                                  |Simulating: |============================                                 |Simulating: |=============================                                |Simulating: |==============================                               |Simulating: |===============================                              |Simulating: |================================                             |Simulating: |=================================                            |Simulating: |==================================                           |Simulating: |===================================                          |Simulating: |====================================                         |Simulating: |=====================================                        |Simulating: |======================================                       |Simulating: |=======================================                      |Simulating: |========================================                     |Simulating: |=========================================                    |Simulating: |==========================================                   |Simulating: |===========================================                  |Simulating: |============================================                 |Simulating: |=============================================                |Simulating: |==============================================               |Simulating: |===============================================              |Simulating: |================================================             |Simulating: |=================================================            |Simulating: |==================================================           |Simulating: |===================================================          |Simulating: |====================================================         |Simulating: |=====================================================        |Simulating: |======================================================       |Simulating: |=======================================================      |Simulating: |========================================================     |Simulating: |=========================================================    |Simulating: |==========================================================   |Simulating: |===========================================================  |Simulating: |============================================================ |Simulating: |=============================================================|

    ## Warning in observedPowerWarning(sim): This appears to be an "observed
    ## power" calculation

    interaction

    ## Power for predictor 'Visit:Diagnosis:verbalIQ1', (95% confidence interval):
    ##       98.00% (92.96, 99.76)
    ## 
    ## Test: unknown test
    ## 
    ## Based on 100 simulations, (0 warnings, 0 errors)
    ## alpha = 0.05, nrow = 387
    ## 
    ## Time elapsed: 0 h 0 m 30 s
    ## 
    ## nb: result might be an observed power calculation

    # plot the powercurve
    # Finding out how many participants we would need to replicate
    pc_inter <- powerCurve(model, test =  fixed("Visit:Diagnosis:verbalIQ1"), along = "Child.ID", nsim = 10, seed = 1, progress = F)

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients

    ## fixed-effect model matrix is rank deficient so dropping 1 column / coefficient

    ## Warning in observedPowerWarning(sim): This appears to be an "observed
    ## power" calculation

    print(pc_inter) # need a sample size of 46 to have a power estimate of <80 % if we want to ensure a three-way interaction effect when replicating 

    ## Power for predictor 'Visit:Diagnosis:verbalIQ1', (95% confidence interval),
    ## by number of levels in Child.ID:
    ##       3:  0.00% ( 0.00, 30.85) - 17 rows
    ##      10: 20.00% ( 2.52, 55.61) - 56 rows
    ##      17: 40.00% (12.16, 73.76) - 97 rows
    ##      24: 60.00% (26.24, 87.84) - 139 rows
    ##      31: 90.00% (55.50, 99.75) - 180 rows
    ##      39: 90.00% (55.50, 99.75) - 227 rows
    ##      46: 90.00% (55.50, 99.75) - 266 rows
    ##      53: 90.00% (55.50, 99.75) - 307 rows
    ##      60: 100.0% (69.15, 100.0) - 346 rows
    ##      67: 100.0% (69.15, 100.0) - 387 rows
    ## 
    ## Time elapsed: 0 h 0 m 18 s

    plot(pc_inter)

![](A2_P3_LanguageASD_power_instructions_files/figure-markdown_strict/unnamed-chunk-1-1.png)

### Exercise 2

How would you perform a more conservative power analysis?

-   Identify and justify a minimum effect size for each of your relevant
    effects

-   take the model from exercise 1 and replace the effects with the
    minimum effect size that you'd accept.

<!-- -->

    # Replacing the minimum effect size
    summary(model)

    ## Linear mixed model fit by maximum likelihood . t-tests use
    ##   Satterthwaite's method [lmerModLmerTest]
    ## Formula: CHI_MLU ~ Visit * Diagnosis * verbalIQ1 + (1 + Visit | Child.ID)
    ##    Data: df
    ## Control: lmerControl(optimizer = "nloptwrap", calc.derivs = F)
    ## 
    ##      AIC      BIC   logLik deviance df.resid 
    ##    539.3    586.8   -257.7    515.3      375 
    ## 
    ## Scaled residuals: 
    ##      Min       1Q   Median       3Q      Max 
    ## -2.56500 -0.58781 -0.07297  0.44014  3.01780 
    ## 
    ## Random effects:
    ##  Groups   Name        Variance Std.Dev. Corr 
    ##  Child.ID (Intercept) 0.090198 0.30033       
    ##           Visit       0.006706 0.08189  -0.42
    ##  Residual             0.157396 0.39673       
    ## Number of obs: 387, groups:  Child.ID, 67
    ## 
    ## Fixed effects:
    ##                              Estimate Std. Error        df t value
    ## (Intercept)                  0.201629   0.223658 65.516309   0.902
    ## Visit                       -0.081759   0.058948 66.032816  -1.387
    ## DiagnosisTD                 -0.656062   0.401937 64.840824  -1.632
    ## verbalIQ1                    0.063693   0.011819 66.289727   5.389
    ## Visit:DiagnosisTD            0.651255   0.106155 65.520074   6.135
    ## Visit:verbalIQ1              0.010353   0.003103 66.059492   3.337
    ## DiagnosisTD:verbalIQ1        0.014175   0.020152 65.442148   0.703
    ## Visit:DiagnosisTD:verbalIQ1 -0.021289   0.005316 65.825205  -4.005
    ##                             Pr(>|t|)    
    ## (Intercept)                  0.37062    
    ## Visit                        0.17011    
    ## DiagnosisTD                  0.10747    
    ## verbalIQ1                   1.01e-06 ***
    ## Visit:DiagnosisTD           5.53e-08 ***
    ## Visit:verbalIQ1              0.00139 ** 
    ## DiagnosisTD:verbalIQ1        0.48430    
    ## Visit:DiagnosisTD:verbalIQ1  0.00016 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Correlation of Fixed Effects:
    ##             (Intr) Visit  DgnsTD vrbIQ1 Vs:DTD Vs:IQ1 DTD:IQ
    ## Visit       -0.704                                          
    ## DiagnosisTD -0.556  0.392                                   
    ## verbalIQ1   -0.925  0.650  0.515                            
    ## Vst:DgnssTD  0.391 -0.555 -0.704 -0.361                     
    ## Vst:vrblIQ1  0.653 -0.925 -0.363 -0.706  0.514              
    ## DgnssTD:IQ1  0.543 -0.381 -0.955 -0.586  0.672  0.414       
    ## Vst:DTD:IQ1 -0.381  0.540  0.673  0.412 -0.955 -0.584 -0.705

    fixef(model)["Visit:DiagnosisTD:verbalIQ1"] <- 0.02

    powerSim(model , fixed("Visit:DiagnosisTD:verbalIQ1"), nsim = 100, seed = 1, progress = F)

    ## Power for predictor 'Visit:DiagnosisTD:verbalIQ1', (95% confidence interval):
    ##        0.00% ( 0.00,  3.62)
    ## 
    ## Test: unknown test
    ##       Effect size for Visit:DiagnosisTD:verbalIQ1 is 0.020
    ## 
    ## Based on 100 simulations, (0 warnings, 100 errors)
    ## alpha = 0.05, nrow = 387
    ## 
    ## Time elapsed: 0 h 0 m 7 s

    # Power curve for interaction effect
    pc_inter <- powerCurve(model, test =  fixed("Visit:Diagnosis:verbalIQ1"), along = "Child.ID", nsim = 10, seed = 1, progress = F, breaks = seq(from = 10, to = 50, by = 5))
    print(pc_inter) 

    ## Power for predictor 'Visit:Diagnosis:verbalIQ1', (95% confidence interval),
    ## by number of levels in Child.ID:
    ##      10: 10.00% ( 0.25, 44.50) - 56 rows
    ##      15: 30.00% ( 6.67, 65.25) - 86 rows
    ##      20: 70.00% (34.75, 93.33) - 115 rows
    ##      25: 80.00% (44.39, 97.48) - 145 rows
    ##      30: 90.00% (55.50, 99.75) - 174 rows
    ##      35: 90.00% (55.50, 99.75) - 204 rows
    ##      40: 90.00% (55.50, 99.75) - 232 rows
    ##      45: 90.00% (55.50, 99.75) - 260 rows
    ##      50: 90.00% (55.50, 99.75) - 289 rows
    ## 
    ## Time elapsed: 0 h 0 m 16 s

    plot(pc_inter)

![](A2_P3_LanguageASD_power_instructions_files/figure-markdown_strict/unnamed-chunk-2-1.png)

-   assess the power curve by Child.ID, identifying an ideal number of
    participants to estimate each effect

-   if your power estimates do not reach an acceptable threshold
    simulate additional participants and repeat the previous analysis
-   Report the power analysis and comment on what you can (or cannot)
    use its estimates for.

### Exercise 3

Assume you have only the resources to collect 30 kids (15 with ASD and
15 TDs). Identify the power for each relevant effect and discuss whether
it's worth to run the study and why

    # print power curve estimates with intercation effect
    print(pc_inter)

    ## Power for predictor 'Visit:Diagnosis:verbalIQ1', (95% confidence interval),
    ## by number of levels in Child.ID:
    ##      10: 10.00% ( 0.25, 44.50) - 56 rows
    ##      15: 30.00% ( 6.67, 65.25) - 86 rows
    ##      20: 70.00% (34.75, 93.33) - 115 rows
    ##      25: 80.00% (44.39, 97.48) - 145 rows
    ##      30: 90.00% (55.50, 99.75) - 174 rows
    ##      35: 90.00% (55.50, 99.75) - 204 rows
    ##      40: 90.00% (55.50, 99.75) - 232 rows
    ##      45: 90.00% (55.50, 99.75) - 260 rows
    ##      50: 90.00% (55.50, 99.75) - 289 rows
    ## 
    ## Time elapsed: 0 h 0 m 16 s
